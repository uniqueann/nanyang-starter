import{o as t,c as e,w as a,b as s,u as i,d as l,q as n,D as r,k as o,t as d,f as c,j as u,i as h,m as p,E as g,a as f,R as y,S as m,P as b,Q as k,$ as w,W as _,X as v,e as C,r as x,F as I,l as S,Y as B,Z as T,_ as A,a0 as L,J as $,G as D,g as U,T as W,a1 as q}from"./index.694e3e81.js";import{_ as H}from"./uni-icons.d5573f5e.js";import{r as R}from"./uni-app.es.1115fc62.js";import{s as j}from"./uni-status-bar.2ccd1929.js";import{_ as N}from"./_plugin-vue_export-helper.cdc0426e.js";import{_ as F}from"./unicloud-db.b0e9ab69.js";import{t as z}from"./publish-time.4a9adb49.js";const P=t=>"number"==typeof t?t+"px":t;const E=N({name:"UniNavBar",components:{statusBar:j},emits:["clickLeft","clickRight","clickTitle"],props:{dark:{type:Boolean,default:!1},title:{type:String,default:""},leftText:{type:String,default:""},rightText:{type:String,default:""},leftIcon:{type:String,default:""},rightIcon:{type:String,default:""},fixed:{type:[Boolean,String],default:!1},color:{type:String,default:""},backgroundColor:{type:String,default:""},statusBar:{type:[Boolean,String],default:!1},shadow:{type:[Boolean,String],default:!1},border:{type:[Boolean,String],default:!0},height:{type:[Number,String],default:44},leftWidth:{type:[Number,String],default:60},rightWidth:{type:[Number,String],default:60},stat:{type:[Boolean,String],default:""}},computed:{themeBgColor(){return this.dark?this.backgroundColor?this.backgroundColor:this.dark?"#333":"#FFF":this.backgroundColor||"#FFF"},themeColor(){return this.dark?this.color?this.color:this.dark?"#fff":"#333":this.color||"#333"},navbarHeight(){return P(this.height)},leftIconWidth(){return P(this.leftWidth)},rightIconWidth(){return P(this.rightWidth)}},mounted(){uni.report&&this.stat&&""!==this.title&&uni.report("title",this.title)},methods:{onClickLeft(){this.$emit("clickLeft")},onClickRight(){this.$emit("clickRight")},onClickTitle(){this.$emit("clickTitle")}}},[["render",function(g,f,y,m,b,k){const w=c("status-bar"),_=R(u("uni-icons"),H),v=h,C=p;return t(),e(v,{class:r(["uni-navbar",{"uni-dark":y.dark,"uni-nvue-fixed":y.fixed}])},{default:a((()=>[s(v,{class:r(["uni-navbar__content",{"uni-navbar--fixed":y.fixed,"uni-navbar--shadow":y.shadow,"uni-navbar--border":y.border}]),style:l({"background-color":k.themeBgColor,"border-bottom-color":k.themeColor})},{default:a((()=>[y.statusBar?(t(),e(w,{key:0})):i("",!0),s(v,{style:l({color:k.themeColor,backgroundColor:k.themeBgColor,height:k.navbarHeight}),class:"uni-navbar__header"},{default:a((()=>[s(v,{onClick:k.onClickLeft,class:"uni-navbar__header-btns uni-navbar__header-btns-left",style:l({width:k.leftIconWidth})},{default:a((()=>[n(g.$slots,"left",{},(()=>[y.leftIcon.length>0?(t(),e(v,{key:0,class:"uni-navbar__content_view"},{default:a((()=>[s(_,{color:k.themeColor,type:y.leftIcon,size:"20"},null,8,["color","type"])])),_:1})):i("",!0),y.leftText.length?(t(),e(v,{key:1,class:r([{"uni-navbar-btn-icon-left":!y.leftIcon.length>0},"uni-navbar-btn-text"])},{default:a((()=>[s(C,{style:l({color:k.themeColor,fontSize:"12px"})},{default:a((()=>[o(d(y.leftText),1)])),_:1},8,["style"])])),_:1},8,["class"])):i("",!0)]),!0)])),_:3},8,["onClick","style"]),s(v,{class:"uni-navbar__header-container",onClick:k.onClickTitle},{default:a((()=>[n(g.$slots,"default",{},(()=>[y.title.length>0?(t(),e(v,{key:0,class:"uni-navbar__header-container-inner"},{default:a((()=>[s(C,{class:"uni-nav-bar-text uni-ellipsis-1",style:l({color:k.themeColor})},{default:a((()=>[o(d(y.title),1)])),_:1},8,["style"])])),_:1})):i("",!0)]),!0)])),_:3},8,["onClick"]),s(v,{onClick:k.onClickRight,class:"uni-navbar__header-btns uni-navbar__header-btns-right",style:l({width:k.rightIconWidth})},{default:a((()=>[n(g.$slots,"right",{},(()=>[y.rightIcon.length?(t(),e(v,{key:0},{default:a((()=>[s(_,{color:k.themeColor,type:y.rightIcon,size:"22"},null,8,["color","type"])])),_:1})):i("",!0),y.rightText.length&&!y.rightIcon.length?(t(),e(v,{key:1,class:"uni-navbar-btn-text"},{default:a((()=>[s(C,{class:"uni-nav-bar-right-text",style:l({color:k.themeColor})},{default:a((()=>[o(d(y.rightText),1)])),_:1},8,["style"])])),_:1})):i("",!0)]),!0)])),_:3},8,["onClick","style"])])),_:3},8,["style"])])),_:3},8,["class","style"]),y.fixed?(t(),e(v,{key:0,class:"uni-navbar__placeholder"},{default:a((()=>[y.statusBar?(t(),e(w,{key:0})):i("",!0),s(v,{class:"uni-navbar__placeholder-view",style:l({height:k.navbarHeight})},null,8,["style"])])),_:1})):i("",!0)])),_:3},8,["class"])}],["__scopeId","data-v-d8073948"]]),O=g.database();const J=N({name:"render-article-detail",props:{delta:{type:Object,default:{}},adConfig:{type:Object,default:{}}},data:()=>({renderData:[]}),components:{unlockContent:N({name:"ad",props:{adpId:String,watchAdUniqueType:{type:String,default:"device"}},data:()=>({currentArticleId:"",currentPageRoute:"",adLoading:!1,isLoadError:!1}),computed:{urlCallback(){return{extra:JSON.stringify({article_id:this.currentArticleId,unique_id:this.uniqueId,unique_type:this.watchAdUniqueType})}},watchByDevice(){return"device"===this.watchAdUniqueType},watchByUser(){return"user"===this.watchAdUniqueType},uniqueId(){return this.watchByDevice?f().deviceId:g.getCurrentUserInfo().uid}},methods:{callAd:()=>y({content:"需观看广告解锁内容, 但浏览器不支持广告播放, 请在App或小程序中操作",showCancel:!1}),onAdLoad(){this.adLoading&&this.$refs.rewardedVideo.show(),console.log("广告数据加载成功")},onAdClose(t){console.log("close",t);const e=t.detail;let a=3;if(m(),this.adLoading=!1,e&&e.isEnded){b({title:"正在解锁全文",timeout:7e3});let t=setInterval((async()=>{a--;const e=await O.collection("uni-cms-unlock-record").where({unique_id:this.uniqueId,article_id:this.currentArticleId}).get();a<=0?(console.log("解锁失败",a),clearInterval(t),m(),k({title:"解锁失败！",icon:"error",duration:2e3})):e.result&&e.result.data.length&&(console.log("解锁成功",a),clearInterval(t),m(),k({title:"解锁成功！",icon:"success",duration:2e3}),w("onUnlockContent"))}),1500)}else y({content:"请观看完整视频后解锁全文",showCancel:!1})},onAdError(t){console.error("onaderror: ",t)}}},[["render",function(i,l,n,r,d,c){const u=_,p=h;return t(),e(p,{class:"unlock-content"},{default:a((()=>[s(u,{class:"text",onClick:c.callAd},{default:a((()=>[o("请观看广告后解锁全文")])),_:1},8,["onClick"])])),_:1})}],["__scopeId","data-v-adf56c4f"]])},mounted(){this.dataPreHandler()},methods:{getRowClass:t=>t?Array.from(t.reduce(((t,e)=>(t.add(e.type),t)),new Set)):[],deltaHandler:t=>[].concat.apply([],t.map((t=>{if("string"!=typeof t.insert)return t;if("\n"===t.insert)return t;const e=t.insert.split("\n");return[].concat.apply([],e.flatMap(((a,s)=>{if(a||s===e.length-1&&!a){const e=[];return s>0&&e.push({insert:"\n",attributes:{}}),e.push({insert:a,attributes:t.attributes}),e}})).filter((t=>t)))}))),dataPreHandler(){const t=[];let e=[],a=null;const s=this.deltaHandler(this.delta.ops);for(const i of s)if("string"==typeof i.insert){if("\n"===i.insert){if(a&&a.data.type!==i.attributes.list&&(t.push({rowItems:[a],rowAttributes:{},rowClass:"",rowStyle:""}),a=null),i.attributes&&i.attributes.list){a||(a={type:"list",data:{type:i.attributes.list,items:[]}}),a.data.items.push(e.length>0?e:[e]),e=[];continue}t.push({rowItems:e,rowAttributes:i.attributes||{},rowClass:this.attributes2class(e,i.attributes,"block"),rowStyle:this.attributes2style(i.attributes,"block")}),e=[];continue}const s=i.insert.split("\n").filter((t=>t));s.length>0&&e.push({type:"text",data:{texts:s,attributes:i.attributes||{},class:this.attributes2class(null,i.attributes,"inline"),style:this.attributes2style(i.attributes,"inline")}})}else i.insert.image?e.push({type:"image",data:{url:i.insert.image,attributes:i.attributes||{},class:this.attributes2class(null,i.attributes,"inline"),style:this.attributes2style(i.attributes,"inline")}}):i.insert.divider?e.push({type:"divider"}):i.insert.unlockContent&&e.push({type:"unlockContent"});a&&t.push({rowItems:[a],rowAttributes:{},rowClass:"",rowStyle:""}),e.length>0&&(t.push({rowItems:e}),e=[]),this.renderData=t},attributes2class(t,e,a){if(!e)return"";const s={inline:["bold","italic","underline","strike","ins","link"],block:["header","list"]}[a];if(!s)throw new Error("type not supported");const i=s.reduce(((t,a)=>e?(!0===e[a]?t.push(a):void 0!==e[a]&&t.push(`${a}-${e[a]}`),t):t),[]);if("link"in e&&i.push("link"),t){const e=this.getRowClass(t);e&&e.length&&i.push(...e)}return i.join(" ")},attributes2style(t,e){if(!t)return"";const a={inline:["align","color","background","font","fontSize","fontStyle","fontVariant","fontWeight","fontFamily","lineHeight","letterSpacing","textDecoration","textIndent","wordWrap","wordBreak","whiteSpace"],block:["align","margin","marginTop","marginBottom","marginLeft","marginRight","padding","paddingTop","paddingBottom","paddingLeft","paddingRight"]}[e],s={align:"text-align"};if(!a)throw new Error("type not supported");return a.reduce(((e,a)=>t?(void 0!==t[a]&&e.push(`${s[a]||a.replace(/([A-Z])/g,((t,e)=>`-${e.toLowerCase()}`))}: ${t[a]}`),e):e),[]).join(";")},goLink(t){t&&window.open(t,"_blank")},imagePreview(t){t&&v({current:t.split("?")[0],urls:[t.split("?")[0]]})},imageLoad(t){const{idx:e,rowIdx:a}=t.target.dataset,s=this.wxAutoImageCal(t.detail.width,t.detail.height,15),i=this.renderData[a].rowItems[e];(!i.data.attributes.width||i.data.attributes.width>s.imageWidth)&&(this.$set(this.renderData[a].rowItems[e].data.attributes,"width",s.imageWidth),this.$set(this.renderData[a].rowItems[e].data.attributes,"height",s.imageheight))},wxAutoImageCal(t,e,a=0){const s=f();let i=0,l=0,n=0,r={};return i=s.windowWidth-2*a,s.windowHeight,t>i?(l=i,n=l*e/t,r.imageWidth=l,r.imageheight=n):(r.imageWidth=t,r.imageheight=e),r}}},[["render",function(n,u,g,f,y,m){const b=h,k=p,w=S,_=c("unlock-content");return t(),e(b,null,{default:a((()=>[(t(!0),C(I,null,x(y.renderData,((n,c)=>(t(),e(b,{class:r(["paragraph",n.rowClass]),style:l(n.rowStyle)},{default:a((()=>[(t(!0),C(I,null,x(n.rowItems,((n,u)=>(t(),C(I,null,["text"===n.type?(t(),C(I,{key:0},[n.data.texts.length>1?(t(!0),C(I,{key:0},x(n.data.texts,(s=>(t(),e(b,{class:r(["p",n.data.class]),style:l(n.data.style)},{default:a((()=>[o(d(s),1)])),_:2},1032,["class","style"])))),256)):(t(!0),C(I,{key:1},x(n.data.texts,(s=>(t(),C(I,null,[n.data.attributes.link?(t(),e(k,{key:0,class:r(n.data.class),style:l(n.data.style),onClick:t=>m.goLink(n.data.attributes.link)},{default:a((()=>[o(d(s),1)])),_:2},1032,["class","style","onClick"])):(t(),e(k,{key:1,class:r(n.data.class),style:l(n.data.style)},{default:a((()=>[o(d(s),1)])),_:2},1032,["class","style"]))],64)))),256))],64)):"list"===n.type?(t(),e(b,{key:1,class:r(["list",n.data.type])},{default:a((()=>[(t(!0),C(I,null,x(n.data.items,((s,c)=>(t(),e(b,{class:"li"},{default:a((()=>["ordered"===n.data.type?(t(),e(k,{key:0,class:"no"},{default:a((()=>[o(d(c+1)+".",1)])),_:2},1024)):"bullet"===n.data.type?(t(),e(k,{key:1,class:"no"})):i("",!0),(t(!0),C(I,null,x(s,(s=>(t(),C(I,null,[(t(!0),C(I,null,x(s.data.texts,(i=>(t(),C(I,null,[s.data.attributes.link?(t(),e(k,{key:0,class:r(s.data.class),style:l(s.data.style),onClick:t=>m.goLink(s.data.attributes.link)},{default:a((()=>[o(d(i),1)])),_:2},1032,["class","style","onClick"])):(t(),e(k,{key:1,class:r(s.data.class),style:l(s.data.style)},{default:a((()=>[o(d(i),1)])),_:2},1032,["class","style"]))],64)))),256))],64)))),256))])),_:2},1024)))),256))])),_:2},1032,["class"])):"image"===n.type?(t(),e(b,{key:2,class:"image"},{default:a((()=>[s(w,{src:n.data.url,class:r(["img",n.data.class]),alt:n.data.attributes.alt||"",style:l({width:`${n.data.attributes.width}px`,height:`${n.data.attributes.height}px`}),mode:"aspectFill","data-row-idx":c,"data-idx":u,onLoad:m.imageLoad,onClick:t=>m.imagePreview(n.data.url)},null,8,["src","class","alt","style","data-row-idx","data-idx","onLoad","onClick"])])),_:2},1024)):"unlockContent"===n.type?(t(),e(_,{key:3,"adp-id":g.adConfig.adpId,"watch-ad-unique-type":g.adConfig.watchAdUniqueType},null,8,["adp-id","watch-ad-unique-type"])):"divider"===n.type?(t(),e(b,{key:4,class:"divider"})):i("",!0)],64)))),256))])),_:2},1032,["class","style"])))),256))])),_:1})}],["__scopeId","data-v-2a8c3e54"]]),M=g.database();const V=N({components:{uniNavBar:E,renderArticleDetail:J},data:()=>({showNavBar:!1,coverImage:{url:"",exists:!0,show:!1,width:1,height:1},id:"",title:"",formData:{},adpId:"",watchAdUniqueType:"device"}),computed:{where(){return`_id =="${this.id}"`},collection(){return[M.collection("uni-cms-articles").where(this.where).field("user_id,thumbnail,excerpt,publish_date,title,content").getTemp(),M.collection("uni-id-users").field("_id, nickname").getTemp()]}},onReady(){this.id?this.$refs.detail.loadData():k({icon:"none",title:"id 不能为空"})},onLoad(t){t.id&&(this.id=t.id),B("onUnlockContent",this.onUnlockContent)},onUnload(){T("onUnlockContent",this.onUnlockContent)},onPageScroll(t){const e=this.coverImage.height-100>0?this.coverImage.height-100:200;t.scrollTop>e?this.showNavBar=!0:this.showNavBar=!1},methods:{publishTime:t=>z(t),back(){const t=A().length,e="/uni_modules/uni-cms-article/pages/list/list";t.length>1?L({}):$({url:e,fail:t=>{-1!==t.errMsg.indexOf("tabbar")&&D({url:e})}})},setReadHistory(){const t=(U("readHistory")||[]).filter((t=>t.article_id!==this.id));t.unshift({article_id:this.id,last_time:Date.now()}),W("readHistory",t)},loadData(t){t.thumbnail||(this.coverImage.exists=!1),this.title=t.title,this.setReadHistory()},setCoverImageSize(t){const{width:e,height:a}=t.detail;q({success:({windowWidth:t})=>{this.coverImage.width=t,this.coverImage.height=t/e*a,this.coverImage.show=!0}})},async onUnlockContent(){this.$refs.detail.loadData()}}},[["render",function(l,n,g,f,y,m){const b=R(u("uni-icons"),H),k=h,w=p,_=R(u("uni-nav-bar"),E),v=S,x=c("render-article-detail"),B=R(u("unicloud-db"),F);return t(),e(B,{collection:m.collection,options:y.formData,getone:!0,where:m.where,manual:!0,ref:"detail",foreignKey:"uni-cms-articles.user_id",onLoad:m.loadData,class:"article"},{default:a((({data:l,loading:n,error:c,options:u})=>[s(_,{class:r(["nav-bar",y.showNavBar?"show":""]),statusBar:!0,border:!1,rightWidth:"180rpx",backgroundColor:"transparent"},{left:a((()=>[s(k,{class:"back",onClick:m.back},{default:a((()=>[s(b,{class:"icon",color:y.showNavBar?"#333333":"#ffffff",type:"left",size:"48rpx"},null,8,["color"])])),_:1},8,["onClick"])])),default:a((()=>[s(k,{class:"title"},{default:a((()=>[s(w,{class:"text"},{default:a((()=>[o(d(y.title),1)])),_:1})])),_:1})])),_:1},8,["class"]),s(k,{class:r(["cover",{placeholder:!y.coverImage.show,"not-cover":!y.coverImage.exists}])},{default:a((()=>[l&&l.thumbnail?(t(),e(v,{key:0,class:r(["img",y.coverImage.show?"show":""]),src:l.thumbnail,mode:"aspectFill",onLoad:m.setCoverImageSize,style:{width:"100%",height:"100%"}},null,8,["class","src","onLoad"])):i("",!0),s(k,{class:"mask"})])),_:2},1032,["class"]),!n&&l?(t(),C(I,{key:0},[s(k,{class:"meta"},{default:a((()=>[s(k,{class:"title"},{default:a((()=>[s(w,{class:"text"},{default:a((()=>[o(d(l.title),1)])),_:2},1024)])),_:2},1024),s(k,{class:"excerpt"},{default:a((()=>[s(w,{class:"text"},{default:a((()=>[o(d(l.excerpt),1)])),_:2},1024)])),_:2},1024),s(k,{class:"author"},{default:a((()=>[l.user_id[0]?(t(),C(I,{key:0},[s(w,{class:"at"},{default:a((()=>[o(d(l.user_id[0].nickname||""),1)])),_:2},1024),s(w,{class:"split"},{default:a((()=>[o("·")])),_:1})],64)):i("",!0),s(w,{class:"date"},{default:a((()=>[o(d(m.publishTime(l.publish_date)),1)])),_:2},1024)])),_:2},1024)])),_:2},1024),s(k,{class:"content"},{default:a((()=>[s(x,{delta:l.content,"ad-config":{adpId:y.adpId,watchAdUniqueType:y.watchAdUniqueType}},null,8,["delta","ad-config"])])),_:2},1024)],64)):(t(),e(k,{key:1,class:"detail-loading"},{default:a((()=>[s(b,{type:"spinner-cycle",size:"35px"})])),_:1}))])),_:1},8,["collection","options","where","onLoad"])}],["__scopeId","data-v-09b6998e"]]);export{V as default};
