import{D as e,g as t,h as s,u as a,v as o,x as i,a as l,s as c,o as r,c as n,w as d,i as h,b as u,e as f,k as _,F as p,r as m,l as y,t as L,d as b,j as g,p as k,m as w}from"./index-0982dc28.js";import{_ as x}from"./uni-search-bar.3f77c41f.js";import{r as S}from"./uni-app.es.0abf17f1.js";import{_ as C}from"./uni-icons.3b963afa.js";import{_ as D}from"./unicloud-db.9e3e3341.js";import{_ as v,a as H}from"./uni-list.41a88308.js";import{_ as T}from"./uni-load-state.19d22a78.js";import{t as I}from"./publish-time.42a692e1.js";import{_ as j}from"./_plugin-vue_export-helper.1b428a4d.js";const M=e.database();var z,N,A,B,R,U;const W=j({data:()=>({articleDbName:"uni-cms-articles",searchLogDbName:"opendb-search-logs",statusBarHeight:"0px",localSearchList:t("__local_search_history"),localSearchListDel:!1,netHotListIsHide:!1,searchText:"",iconColor:"#999999",associativeList:[],keyBoardPopup:!1,hotWorld:"DCloud",focus:!0,speechEngine:"iFly",isLoadData:!1,where:'"article_status" == 1',listHeight:0,associativeShow:!1,noAssociativeShow:!1}),created(){this.db=e.database(),this.searchLogDb=this.db.collection(this.searchLogDbName),this.articleDbName=this.db.collection(this.articleDbName)},computed:{colList(){return[M.collection("uni-cms-articles").where(this.where).field("thumbnail,title,publish_date,user_id").getTemp(),M.collection("uni-id-users").field("_id,nickname").getTemp()]}},onReady(){this.listHeight="auto"},onLoad(){},methods:{clear(e){console.log("res: ",e)},confirm(e){this.search(e.value)},cancel(e){s(),this.searchText="",this.isLoadData=!1,this.associativeShow=!1},search(e){(e||this.hotWorld)&&(e?(this.searchText!==e&&(this.searchText=e),this.localSearchListManage(e),this.searchLogDbAdd(e)):this.hotWorld&&(this.searchText=this.hotWorld),s(),this.loadList(this.searchText))},localSearchListManage(e){t("__local_search_history").length?(this.localSearchList.unshift(e),(e=>{for(let t=e.length-1;t>=0;t--){const s=e.indexOf(e[t]),a=e.lastIndexOf(e[t]);s!=a&&e.splice(a,1)}})(this.localSearchList),this.localSearchList.length>10&&this.localSearchList.pop()):this.localSearchList=[e],a("__local_search_history",this.localSearchList)},LocalSearchListClear(){o({content:"确认清空搜索历史吗",confirmText:"删除",confirmColor:"red",cancelColor:"#808080",success:e=>{e.confirm&&(this.localSearchListDel=!1,this.localSearchList=[],i("__local_search_history"))}})},LocalSearchlistItemClick(e,t){if(this.localSearchListDel)return this.localSearchList.splice(t,1),a("__local_search_history",this.localSearchList),void(this.localSearchList.length||(this.localSearchListDel=!1));this.noAssociativeShow=!0,this.search(e)},searchHotRefresh(){this.$refs.udb.refresh()},speech(){},searchLogDbAdd(e){this.getDeviceId().then((t=>{this.searchLogDb.add({device_id:t,content:e,create_date:Date.now()})}))},getDeviceId:()=>new Promise(((e,s)=>{const a=t("uni_id");e(a||l().system+"_"+Math.random().toString(36).substr(2))})),associativeClick(e){console.log("associativeClick: ",e,e.title),this.noAssociativeShow=!0,this.searchText=e.title,this.loadList(e.title)},loadList(e=""){let t='"article_status" == 1 ';this.where=e?`"article_status" == 1 && /${e}/.test(title)`:t,this.associativeList=[],this.associativeShow=!1,setTimeout((()=>{this.$refs.listUdb.loadData({clear:!0})}),0)},onDbLoad(){console.log("onDbLoad"),this.isLoadData=!0,this.noAssociativeShow=!1},onqueryerror(e){console.error(e)},refresh(){this.$refs.listUdb.loadData({clear:!0},(()=>{c()}))},loadMore(){this.$refs.listUdb.loadMore()},publishTime:e=>I(e)},onReachBottom(){this.loadMore()},watch:{searchText:(z=function(e,t){e!==t&&(this.noAssociativeShow||(e?this.articleDbName.where({title:new RegExp(e,"gi")}).field("_id,title").get().then((e=>{this.associativeList=e.result.data,this.associativeShow=!0})):this.associativeList=[]))},N=100,B=z,R=null,U=!0,A&&B(),function(){var e=arguments,t=this;U&&(U=!1,B.apply(t,e)),R&&clearTimeout(R),R=setTimeout((function(){clearTimeout(R),R=null,B.apply(t,e)}),N||200)})}},[["render",function(e,t,s,a,o,i){const l=S(g("uni-search-bar"),x),c=h,I=k,j=S(g("uni-icons"),C),M=S(g("unicloud-db"),D),z=w,N=S(g("uni-list-item"),v),A=S(g("uni-load-state"),T),B=S(g("uni-list"),H);return r(),n(c,{class:"container"},{default:d((()=>[u(c,{class:"search-container"},{default:d((()=>[u(c,{class:"search-container-bar"},{default:d((()=>[u(l,{ref:"searchBar",style:{flex:"1"},radius:"100",modelValue:o.searchText,"onUpdate:modelValue":t[0]||(t[0]=e=>o.searchText=e),focus:o.focus,placeholder:o.hotWorld,clearButton:"auto",cancelButton:"always",onClear:i.clear,onConfirm:i.confirm,onCancel:i.cancel},null,8,["modelValue","focus","placeholder","onClear","onConfirm","onCancel"])])),_:1})])),_:1}),u(c,{class:"search-body"},{default:d((()=>[u(M,{ref:"listUdb",onError:i.onqueryerror,collection:i.colList,"page-size":10,orderby:"publish_date desc",onLoad:i.onDbLoad,loadtime:"manual"},{default:d((({data:e,pagination:s,hasMore:a,loading:l,error:h,options:g})=>[o.isLoadData?(r(),n(B,{key:1,class:"uni-list",border:!1,style:b({height:o.listHeight})},{default:d((()=>[(r(!0),f(p,null,m(e,((e,t)=>(r(),n(N,{to:"/uni_modules/uni-cms-article/pages/detail/detail?id="+e._id,key:t},{header:d((()=>[u(z,{class:"thumbnail",src:e.thumbnail,mode:"aspectFill"},null,8,["src"])])),body:d((()=>[u(c,{class:"main"},{default:d((()=>[u(I,{class:"title"},{default:d((()=>[_(L(e.title),1)])),_:2},1024),u(c,{class:"info"},{default:d((()=>[u(I,{class:"author"},{default:d((()=>[_(L(e.user_id[0]?e.user_id[0].nickname:""),1)])),_:2},1024),u(I,{class:"publish_date"},{default:d((()=>[_(L(i.publishTime(e.publish_date)),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1032,["to"])))),128)),u(A,{onNetworkResume:i.refresh,state:{data:e,pagination:s,hasMore:a,loading:l,error:h},onLoadMore:i.loadMore},null,8,["onNetworkResume","state","onLoadMore"])])),_:2},1032,["style"])):(r(),f(p,{key:0},[o.localSearchList.length?(r(),n(c,{key:0,class:"word-container"},{default:d((()=>[u(c,{class:"word-container_header"},{default:d((()=>[u(I,{class:"word-container_header-text"},{default:d((()=>[_("搜索历史")])),_:1}),o.localSearchListDel?(r(),n(c,{key:1,class:"flex-center flex-row",style:{"font-weight":"500","justify-content":"space-between"}},{default:d((()=>[u(I,{style:{"font-size":"22rpx",color:"#666","padding-top":"4rpx","padding-bottom":"4rpx","padding-right":"20rpx"},onClick:i.LocalSearchListClear},{default:d((()=>[_("全部删除")])),_:1},8,["onClick"]),u(I,{style:{"font-size":"22rpx",color:"#c0402b","padding-top":"4rpx","padding-bottom":"4rpx","padding-left":"20rpx"},onClick:t[2]||(t[2]=e=>o.localSearchListDel=!1)},{default:d((()=>[_("完成")])),_:1})])),_:1})):(r(),n(j,{key:0,onClick:t[1]||(t[1]=e=>o.localSearchListDel=!0),class:"search-icons",style:{"padding-right":"0"},color:o.iconColor,size:"18",type:"trash"},null,8,["color"]))])),_:1}),u(c,{class:"word-container_body"},{default:d((()=>[(r(!0),f(p,null,m(o.localSearchList,((e,t)=>(r(),n(c,{class:"flex-center flex-row word-container_body-text",key:t,onClick:s=>i.LocalSearchlistItemClick(e,t)},{default:d((()=>[(r(),n(I,{class:"word-display",key:e},{default:d((()=>[_(L(e),1)])),_:2},1024)),o.localSearchListDel?(r(),n(j,{key:0,size:"12",type:"closeempty"})):y("",!0)])),_:2},1032,["onClick"])))),128))])),_:1})])),_:1})):y("",!0),u(c,{class:"word-container"},{default:d((()=>[u(c,{class:"word-container_header"},{default:d((()=>[u(c,{class:"flex-center flex-row"},{default:d((()=>[u(I,{class:"word-container_header-text"},{default:d((()=>[_("搜索发现")])),_:1}),o.netHotListIsHide?y("",!0):(r(),n(j,{key:0,class:"search-icons",color:o.iconColor,size:"14",type:"reload",onClick:i.searchHotRefresh},null,8,["color","onClick"]))])),_:1}),u(j,{class:"search-icons",style:{"padding-right":"0"},color:o.iconColor,size:"18",type:o.netHotListIsHide?"eye-slash":"eye",onClick:t[3]||(t[3]=e=>o.netHotListIsHide=!o.netHotListIsHide)},null,8,["color","type"])])),_:1}),u(M,{ref:"udb",field:"content",collection:"opendb-search-hot",orderby:"create_date desc,count desc","page-data":"replace","page-size":10},{default:d((({data:e,loading:t,error:s,options:a})=>[t&&!o.netHotListIsHide?(r(),n(I,{key:0,class:"word-container_body-info"},{default:d((()=>[_("正在加载...")])),_:1})):(r(),n(c,{key:1,class:"word-container_body"},{default:d((()=>[o.netHotListIsHide?(r(),n(c,{key:1,style:{flex:"1"}},{default:d((()=>[u(I,{class:"word-container_body-info"},{default:d((()=>[_("当前搜索发现已隐藏")])),_:1})])),_:1})):(r(),f(p,{key:0},[s?(r(),n(I,{key:0,class:"word-container_body-info"},{default:d((()=>[_(L(s.message),1)])),_:2},1024)):(r(!0),f(p,{key:1},m(e,((e,t)=>(r(),n(I,{class:"word-container_body-text",key:t,onClick:t=>i.search(e.content)},{default:d((()=>[_(L(e.content),1)])),_:2},1032,["onClick"])))),128))],64))])),_:2},1024))])),_:2},1536)])),_:2},1024)],64))])),_:1},8,["onError","collection","onLoad"])])),_:1}),o.associativeShow?(r(),n(c,{key:0,class:"search-associative"},{default:d((()=>[u(B,null,{default:d((()=>[(r(!0),f(p,null,m(o.associativeList,((e,t)=>(r(),n(N,{key:e._id,ellipsis:1,title:e.title,onClick:t=>i.associativeClick(e),"show-extra-icon":"",clickable:"","extra-icon":{size:18,color:o.iconColor,type:"search"}},null,8,["title","onClick","extra-icon"])))),128))])),_:1})])),_:1})):y("",!0)])),_:1})}],["__scopeId","data-v-fd9d8a63"]]);export{W as default};
