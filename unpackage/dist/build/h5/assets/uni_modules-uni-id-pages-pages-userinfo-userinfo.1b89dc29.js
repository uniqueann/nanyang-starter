import{a as e,v as i,B as t,D as a,A as o,n as s,a7 as n,j as l,o as r,c,w as u,d,z as p,E as h,ae as m,b as f,k as g,p as y,i as b,C as w,l as _,e as k,F as v}from"./index-0982dc28.js";import{_ as I}from"./cloud-image.9ab3d60e.js";import{r as x}from"./uni-app.es.0abf17f1.js";import{_ as C}from"./uni-icons.3b963afa.js";import{s as M,m as P}from"./store.49192a69.js";import{_ as S}from"./_plugin-vue_export-helper.1b428a4d.js";import{_ as B,a as j}from"./uni-list.41a88308.js";import{_ as T}from"./uni-popup-dialog.ef059ad2.js";import{_ as A}from"./uni-popup.08c373cf.js";const L=S({data:()=>({isPC:!1}),props:{width:{type:String,default:()=>"50px"},height:{type:String,default:()=>"50px"},border:{type:Boolean,default:()=>!1}},async mounted(){this.isPC=!["ios","android"].includes(e().platform)},computed:{hasLogin:()=>M.hasLogin,userInfo:()=>M.userInfo,avatar_file:()=>M.userInfo.avatar_file},methods:{setAvatarFile(e){P.updateUserInfo({avatar_file:e})},async bindchooseavatar(e){let s=e.detail.avatarUrl,n={extname:s.split(".")[s.split(".").length-1],name:"",url:s},l=await new Promise((e=>{wx.cropImage({src:s,cropScale:"1:1",success:i=>{e(i.tempFilePath)},fail(t){console.error(t),i({content:"wx.cropImage "+t.errMsg,showCancel:!1,confirmText:"跳过裁剪",complete(){e(s)}})}})})),r=this.userInfo._id+""+Date.now();n.name=r;try{t({title:"更新中",mask:!0});let{fileID:e}=await a.uploadFile({filePath:l,cloudPath:r,fileType:"image"});n.url=e,o()}catch(c){console.error(c)}this.setAvatarFile(n)},uploadAvatarImg(e){if(!this.hasLogin)return s({url:"/uni_modules/uni-id-pages/pages/login/login-withoutpwd"});const i={quality:100,width:600,height:600,resize:!0};n({count:1,crop:i,success:async e=>{let n=e.tempFiles[0],l={extname:n.name.split(".")[n.name.split(".").length-1]},r=e.tempFilePaths[0];r=await new Promise((e=>{this.isPC||s({url:"/uni_modules/uni-id-pages/pages/userinfo/cropImage/cropImage?path="+r+`&options=${JSON.stringify(i)}`,animationType:"fade-in",events:{success:i=>{e(i)}},complete(e){}})}));let c=this.userInfo._id+""+Date.now();l.name=c,t({title:"更新中",mask:!0});let{fileID:u}=await a.uploadFile({filePath:r,cloudPath:c,fileType:"image"});l.url=u,o(),this.setAvatarFile(l)}})}}},[["render",function(e,i,t,a,o,s){const n=x(l("cloud-image"),I),m=x(l("uni-icons"),C),f=h;return r(),c(f,{"open-type":"chooseAvatar",onChooseavatar:s.bindchooseavatar,onClick:s.uploadAvatarImg,class:p(["box",{showBorder:t.border}]),style:d({width:t.width,height:t.height,lineHeight:t.height})},{default:u((()=>[s.avatar_file?(r(),c(n,{key:0,src:s.avatar_file.url,width:t.width,height:t.height},null,8,["src","width","height"])):(r(),c(m,{key:1,style:d({width:t.width,height:t.height,lineHeight:t.height}),class:"chooseAvatar",type:"plusempty",size:"30",color:"#dddddd"},null,8,["style"]))])),_:1},8,["onChooseavatar","onClick","class","style"])}],["__scopeId","data-v-98a1433c"]]);a.database().collection("uni-id-users");const N=a.importObject("uni-id-co");const F=S({emits:["success"],computed:{},data:()=>({}),methods:{beforeGetphonenumber:async()=>await new Promise(((e,i)=>{t({mask:!0}),wx.checkSession({success(){e(),o()},fail(){m({success({code:t}){a.importObject("uni-id-co",{customUI:!0}).loginByWeixin({code:t}).then((i=>{e()})).catch((e=>{console.log(e),i()})).finally((e=>{o()}))},fail:e=>{console.error(e),i()}})}})})),async bindMobileByMpWeixin(e){"getPhoneNumber:ok"==e.detail.errMsg?(await this.beforeGetphonenumber(),N.bindMobileByMpWeixin(e.detail).then((e=>{this.$emit("success")})).finally((e=>{this.closeMe()}))):this.closeMe()},async open(){this.$refs.popup.open()},closeMe(e){this.$refs.popup.close()}}},[["render",function(e,i,t,a,o,s){const n=y,d=h,p=b,m=x(l("uni-popup"),A);return r(),c(m,{ref:"popup",type:"bottom"},{default:u((()=>[f(p,{class:"box"},{default:u((()=>[f(n,{class:"headBox"},{default:u((()=>[g("绑定资料")])),_:1}),f(n,{class:"tip"},{default:u((()=>[g("将一键获取你的手机号码绑定你的个人资料")])),_:1}),f(p,{class:"btnBox"},{default:u((()=>[f(n,{onClick:s.closeMe,class:"close"},{default:u((()=>[g("关闭")])),_:1},8,["onClick"]),f(d,{class:"agree uni-btn",type:"primary","open-type":"getPhoneNumber",onGetphonenumber:s.bindMobileByMpWeixin},{default:u((()=>[g("获取")])),_:1},8,["onGetphonenumber"])])),_:1})])),_:1})])),_:1},512)}],["__scopeId","data-v-0296d063"]]),U=a.importObject("uni-id-co");const D=S({computed:{userInfo:()=>M.userInfo},data:()=>({univerifyStyle:{authButton:{title:"本机号码一键绑定"},otherLoginButton:{title:"其他号码绑定"}},hasPwd:!1,showLoginManage:!1,setNicknameIng:!1}),async onShow(){this.univerifyStyle.authButton.title="本机号码一键绑定",this.univerifyStyle.otherLoginButton.title="其他号码绑定"},async onLoad(e){e.showLoginManage&&(this.showLoginManage=!0);let i=await U.getAccountInfo();this.hasPwd=i.isPasswordSet},methods:{login(){s({url:"/uni_modules/uni-id-pages/pages/login/login-withoutpwd",complete:e=>{}})},logout(){P.logout()},bindMobileSuccess(){P.updateUserInfo()},changePassword(){s({url:"/uni_modules/uni-id-pages/pages/userinfo/change_pwd/change_pwd",complete:e=>{}})},bindMobile(){this.bindMobileBySmsCode()},univerify(){m({provider:"univerify",univerifyStyle:this.univerifyStyle,success:async e=>{U.bindMobileByUniverify(e.authResult).then((e=>{P.updateUserInfo()})).catch((e=>{console.log(e)})).finally((e=>{uni.closeAuthView()}))},fail:e=>{console.log(e),"30002"!=e.code&&"30001"!=e.code||this.bindMobileBySmsCode()}})},bindMobileBySmsCode(){s({url:"./bind-mobile/bind-mobile"})},setNickname(e){e?(P.updateUserInfo({nickname:e}),this.setNicknameIng=!1,this.$refs.dialog.close()):(this.setNicknameIng=!0,this.$refs.dialog.open())},deactivate(){s({url:"/uni_modules/uni-id-pages/pages/userinfo/deactivate/deactivate"})},async bindThirdAccount(e){const i=a.importObject("uni-id-co"),t={weixin:"wx_openid",alipay:"ali_openid",apple:"apple_openid",qq:"qq_openid"}[e.toLowerCase()];this.userInfo[t]?(await i["unbind"+e](),await P.updateUserInfo()):m({provider:e.toLowerCase(),onlyAuthorize:!0,success:async t=>{const a=await i["bind"+e]({code:t.code});a.errCode&&w({title:a.errMsg||"绑定失败",duration:3e3}),await P.updateUserInfo()},fail:async e=>{console.log(e),o()}})}}},[["render",function(e,i,t,a,o,s){const n=x(l("uni-id-pages-avatar"),L),d=b,p=x(l("uni-list-item"),B),m=x(l("uni-list"),j),y=x(l("uni-popup-dialog"),T),w=x(l("uni-popup"),A),I=x(l("uni-id-pages-bind-mobile"),F),C=h;return r(),c(d,{class:"uni-content"},{default:u((()=>[f(d,{class:"avatar"},{default:u((()=>[f(n,{width:"260rpx",height:"260rpx"})])),_:1}),f(m,null,{default:u((()=>[f(p,{class:"item",onClick:i[0]||(i[0]=e=>s.setNickname("")),title:"昵称",rightText:s.userInfo.nickname||"未设置",link:""},null,8,["rightText"]),f(p,{class:"item",onClick:s.bindMobile,title:"手机号",rightText:s.userInfo.mobile||"未绑定",link:""},null,8,["onClick","rightText"]),s.userInfo.email?(r(),c(p,{key:0,class:"item",title:"电子邮箱",rightText:s.userInfo.email},null,8,["rightText"])):_("",!0),o.hasPwd?(r(),c(p,{key:1,class:"item",onClick:s.changePassword,title:"修改密码",link:""},null,8,["onClick"])):_("",!0)])),_:1}),f(m,{class:"mt10"},{default:u((()=>[f(p,{onClick:s.deactivate,title:"注销账号",link:"navigateTo"},null,8,["onClick"])])),_:1}),f(w,{ref:"dialog",type:"dialog"},{default:u((()=>[f(y,{mode:"input",value:s.userInfo.nickname,onConfirm:s.setNickname,inputType:o.setNicknameIng?"nickname":"text",title:"设置昵称",placeholder:"请输入要设置的昵称"},null,8,["value","onConfirm","inputType"])])),_:1},512),f(I,{ref:"bind-mobile-by-sms",onSuccess:s.bindMobileSuccess},null,8,["onSuccess"]),o.showLoginManage?(r(),k(v,{key:0},[s.userInfo._id?(r(),c(C,{key:0,onClick:s.logout},{default:u((()=>[g("退出登录")])),_:1},8,["onClick"])):(r(),c(C,{key:1,onClick:s.login},{default:u((()=>[g("去登录")])),_:1},8,["onClick"]))],64)):_("",!0)])),_:1})}],["__scopeId","data-v-aaa58fa2"]]);export{D as default};
