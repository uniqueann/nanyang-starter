"use strict";const e=require("../../../../common/vendor.js"),t=e.Ds.database(),o={name:"ad",props:{adpId:String,watchAdUniqueType:{type:String,default:"device"}},data:()=>({currentArticleId:"",currentPageRoute:"",adLoading:!1,isLoadError:!1}),computed:{urlCallback(){return{extra:JSON.stringify({article_id:this.currentArticleId,unique_id:this.uniqueId,unique_type:this.watchAdUniqueType})}},watchByDevice(){return"device"===this.watchAdUniqueType},watchByUser(){return"user"===this.watchAdUniqueType},uniqueId(){return this.watchByDevice?e.index.getSystemInfoSync().deviceId:e.Ds.getCurrentUserInfo().uid}},mounted(){const t=getCurrentPages(),o=t[t.length-1];this.currentArticleId=o.options.id,this.currentPageRoute=o.route,this.adpId?this.$refs.rewardedVideo.load():e.index.showModal({content:"广告位ID未设置，广告无法正常加载",showCancel:!1})},methods:{callAd(){if(this.watchByUser){const t="/uni_modules/uni-id-pages/pages/login/login-withoutpwd"+(this.currentPageRoute?"?uniIdRedirectUrl="+this.currentPageRoute+"?id="+this.currentArticleId:"");e.Ds.getCurrentUserInfo().tokenExpired<Date.now()&&e.index.showModal({content:"请登录后操作",success:({confirm:o})=>{o&&e.index.redirectTo({url:t})}})}this.adLoading=!0,this.$refs.rewardedVideo.show()},onAdLoad(){this.adLoading&&this.$refs.rewardedVideo.show(),console.log("广告数据加载成功")},onAdClose(o){console.log("close",o);const d=o.detail;let r=3;if(e.index.hideLoading(),this.adLoading=!1,d&&d.isEnded){e.index.showLoading({title:"正在解锁全文",timeout:7e3});let o=setInterval((async()=>{r--;const d=await t.collection("uni-cms-unlock-record").where({unique_id:this.uniqueId,article_id:this.currentArticleId}).get();r<=0?(console.log("解锁失败",r),clearInterval(o),e.index.hideLoading(),e.index.showToast({title:"解锁失败！",icon:"error",duration:2e3})):d.result&&d.result.data.length&&(console.log("解锁成功",r),clearInterval(o),e.index.hideLoading(),e.index.showToast({title:"解锁成功！",icon:"success",duration:2e3}),e.index.$emit("onUnlockContent"))}),1500)}else e.index.showModal({content:"请观看完整视频后解锁全文",showCancel:!1})},onAdError(e){console.error("onaderror: ",e)}}};if(!Array){e.resolveComponent("ad-rewarded-video")()}Math;const d=e._export_sfc(o,[["render",function(t,o,d,r,i,n){return e.e({a:e.w((({loading:t,error:o},d,r)=>e.e({a:o},{},{b:r,c:d})),{name:"d",path:"a",vueId:"f5473f66-0"}),b:e.sr("rewardedVideo","f5473f66-0"),c:e.o(n.onAdLoad),d:e.o(n.onAdClose),e:e.o(n.onAdError),f:e.p({adpid:d.adpId,preload:!1,disabled:!0,loadnext:!0,"url-callback":n.urlCallback}),g:!i.isLoadError},i.isLoadError?{}:{h:e.o(((...e)=>n.callAd&&n.callAd(...e))),i:i.adLoading})}],["__scopeId","data-v-f5473f66"]]);wx.createComponent(d);
